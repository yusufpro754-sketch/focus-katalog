<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Akıllı Sipariş Paneli v3.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --header-row: #f1f5f9;
            --category-bg: #312e81;
            --category-text: #fff;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        
        /* ÜST PANEL */
        .header {
            background: var(--white); padding: 15px 5%; 
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .upload-box {
            position: relative; overflow: hidden; display: inline-block;
        }
        
        .btn {
            background: var(--primary); color: white; padding: 10px 20px; 
            border-radius: 8px; font-weight: 600; cursor: pointer; border: none;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { background: #4338ca; }
        
        /* TABLO ALANI */
        .container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { background: var(--header-row); padding: 15px; text-align: left; font-size: 0.85rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        /* KATEGORİ BAŞLIKLARI (Excel'deki ara başlıklar) */
        .cat-row td { background: var(--category-bg); color: var(--category-text); font-weight: bold; padding: 12px 20px; letter-spacing: 1px; }

        /* GİRİŞ ALANLARI (INPUTS) */
        .input-clean {
            width: 100%; padding: 8px; border: 1px solid transparent; 
            border-radius: 6px; font-size: 1rem; outline: none; transition: 0.2s;
            background: transparent;
        }
        .input-clean:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .input-clean:hover { background: #f8fafc; }

        /* Fiyat ve Adet Özel Stilleri */
        .price-input { text-align: right; font-family: 'Consolas', monospace; color: #334155; font-weight: 600; }
        .qty-input { text-align: center; font-weight: bold; width: 60px; margin: 0 5px; }

        /* Adet Butonları */
        .qty-wrapper { display: flex; align-items: center; justify-content: center; }
        .qty-btn {
            width: 32px; height: 32px; border: 1px solid var(--border); background: white;
            border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }
        .qty-btn:hover { background: #f1f5f9; }

        /* ALT TOPLAM */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid var(--border);
            padding: 20px 5%; display: flex; justify-content: flex-end; align-items: center;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); z-index: 100;
        }
        .total-display { font-size: 2rem; font-weight: 800; color: var(--primary); }

        /* Boş Durum */
        .empty-state { text-align: center; padding: 50px; color: #94a3b8; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; color:var(--text);"><i class="fa-solid fa-boxes-stacked"></i> Sipariş Listesi</h2>
        <div class="upload-box">
            <label class="btn">
                <i class="fa-solid fa-file-excel"></i> Excel Dosyası Seç
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv" onchange="processExcel(this)">
            </label>
        </div>
    </div>

    <div class="container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="40%">ÜRÜN ADI</th>
                    <th width="20%" style="text-align:right;">BİRİM FİYAT</th>
                    <th width="20%" style="text-align:center;">ADET</th>
                    <th width="20%" style="text-align:right;">TOPLAM</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="4">
                        <div class="empty-state">
                            <i class="fa-regular fa-folder-open" style="font-size:3rem; margin-bottom:15px;"></i>
                            <p>Lütfen Excel dosyanızı yükleyin.</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="footer-bar">
        <div style="text-align:right;">
            <div style="font-size:0.9rem; color:#64748b; font-weight:600;">GENEL TOPLAM</div>
            <div class="total-display" id="grandTotal">0,00 ₺</div>
        </div>
    </div>

    <script>
        let productData = []; // Tüm veriler burada tutulur

        // --- EXCEL İŞLEME MOTORU (GELİŞMİŞ MATRIX YÖNTEMİ) ---
        function processExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // İlk sayfayı al
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Sayfayı "Satır Satır Dizi" (Array of Arrays) olarak al
                // Bu yöntem "Header" aramaz, ham veriyi verir. Çok daha güvenlidir.
                const rawRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                parseRows(rawRows);
            };
            reader.readAsArrayBuffer(file);
        }

        function parseRows(rows) {
            productData = [];
            let currentCategory = "GENEL LİSTE";

            rows.forEach((row, index) => {
                if (row.length === 0) return; // Boş satırı atla

                // Satırdaki verileri analiz et
                // Genelde 1. sütun İsim, 2. veya 3. sütun Fiyat olur.
                // Senin dosyan karmaşıksa en güvenli yol şudur:
                
                // 1. Satırdaki ilk metni bul (Ürün Adı adayı)
                const textCell = row.find(cell => typeof cell === 'string' && cell.trim().length > 1);
                
                // 2. Satırdaki ilk sayıyı bul (Fiyat adayı)
                const numberCell = row.find(cell => typeof cell === 'number');

                // KARAR MEKANİZMASI:
                
                // Durum A: Hem Metin hem Sayı var -> Bu bir ÜRÜNDÜR
                if (textCell && numberCell !== undefined) {
                    productData.push({
                        type: 'product',
                        id: index,
                        name: textCell,
                        price: parseFloat(numberCell),
                        qty: 0,
                        category: currentCategory
                    });
                }
                // Durum B: Sadece Metin var, Sayı YOK -> Bu bir KATEGORİ BAŞLIĞIDIR
                else if (textCell && numberCell === undefined) {
                    // "Ürün Adı", "Fiyat" gibi başlık satırlarını filtrelemek için kontrol:
                    const ignoreList = ["ürün", "fiyat", "stok", "adet", "toplam", "urun", "kabİn"];
                    if (!ignoreList.some(w => textCell.toLowerCase().includes(w))) {
                        currentCategory = textCell.toUpperCase();
                        productData.push({ type: 'category', title: currentCategory });
                    }
                }
            });

            renderTable();
        }

        // --- TABLO ÇİZİMİ ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            if (productData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state">Veri okunamadı. Lütfen dosya formatını kontrol edin.</td></tr>`;
                return;
            }

            productData.forEach((item, idx) => {
                // Kategori Satırı
                if (item.type === 'category') {
                    const tr = document.createElement('tr');
                    tr.className = 'cat-row';
                    tr.innerHTML = `<td colspan="4">${item.title}</td>`;
                    tbody.appendChild(tr);
                    return;
                }

                // Ürün Satırı
                const tr = document.createElement('tr');
                
                // Fiyat Gösterimi Mantığı: 0 ise boş string, değilse değeri yaz
                const priceValue = item.price === 0 ? '' : item.price;

                tr.innerHTML = `
                    <td>
                        <input type="text" class="input-clean" value="${item.name}" 
                        oninput="updateItem(${idx}, 'name', this.value)">
                    </td>
                    <td>
                        <input type="number" class="input-clean price-input" 
                        placeholder="0" 
                        value="${priceValue}" 
                        oninput="updateItem(${idx}, 'price', this.value)">
                    </td>
                    <td>
                        <div class="qty-wrapper">
                            <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
                            <input type="number" class="input-clean qty-input" 
                            value="${item.qty === 0 ? '' : item.qty}" 
                            placeholder="0"
                            oninput="updateItem(${idx}, 'qty', this.value)">
                            <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
                        </div>
                    </td>
                    <td style="text-align:right; font-weight:bold; color:#16a34a;" id="row-total-${idx}">
                        ${formatMoney(item.price * item.qty)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- VERİ GÜNCELLEME ---
        function updateItem(index, field, value) {
            const item = productData[index];
            
            if (field === 'price' || field === 'qty') {
                // Boş string gelirse 0 kabul et
                const num = value === '' ? 0 : parseFloat(value);
                item[field] = isNaN(num) ? 0 : num;
            } else {
                item[field] = value;
            }

            // Sadece ilgili satırın toplamını güncelle (Hız için)
            const rowTotalEl = document.getElementById(`row-total-${index}`);
            if (rowTotalEl) rowTotalEl.innerText = formatMoney(item.price * item.qty);

            calculateTotal();
        }

        function changeQty(index, delta) {
            const item = productData[index];
            let newVal = item.qty + delta;
            if (newVal < 0) newVal = 0;
            
            item.qty = newVal;
            
            // Tabloyu tamamen yenile (Input değerinin güncellenmesi için en temiz yol)
            renderTable(); 
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            productData.forEach(p => {
                if (p.type === 'product') {
                    total += p.price * p.qty;
                }
            });
            document.getElementById('grandTotal').innerText = formatMoney(total);
        }

        function formatMoney(amount) {
            return amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';
        }

    </script>
</body>
</html>
